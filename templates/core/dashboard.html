{% extends 'base.html' %}

{% block title %}Dashboard - AI Agent Customer Service{% endblock %}

{% block content %}
<!-- Hero Section with Gradient Background -->
<div class="bg-gradient-dark text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-gradient-primary rounded-circle p-3 me-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot fs-3"></i>
                    </div>
                    <div>
                        <h1 class="mb-1 fw-bold">Welcome back, {{ user.first_name|default:user.username }}!</h1>
                        <p class="mb-0 opacity-75">Manage your AI assistant and monitor performance</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-inline-flex align-items-center bg-success rounded-pill px-3 py-2">
                    <div class="bg-white rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                    <span class="fw-medium">AI Assistant Active</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-n3 position-relative" style="z-index: 10;">
    
    <!-- Quick Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-comments text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ profile.api_requests_count }}</h3>
                    <p class="text-muted mb-0">Total Conversations</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-brain text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ profile.tokens_used|floatformat:0 }}</h3>
                    <p class="text-muted mb-0">Tokens Processed</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-question-circle text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ assistant.qnas.count }}</h3>
                    <p class="text-muted mb-0">Q&A Pairs</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-database text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ assistant.knowledge_base.count }}</h3>
                    <p class="text-muted mb-0">Knowledge Items</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Row - AI Assistant & Usage -->
    <div class="row g-4 mb-5">
        
        <!-- Left Column - Subscription Plan (Full Height) -->
        <div class="col-lg-4">
            <div class="card-modern h-100">
                <div class="card-header-modern">
                    <i class="fas fa-crown me-2"></i>
                    <span>Subscription Plan</span>
                </div>
                <div class="card-body-modern">
                    <div class="text-center mb-4">
                        <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                            <i class="fas fa-{% if profile.subscription_plan == 'free' %}gift{% elif profile.subscription_plan == 'pro' %}star{% else %}crown{% endif %} text-white fs-4"></i>
                        </div>
                        <h5 class="fw-bold text-capitalize">{{ profile.subscription_plan }}{% if profile.subscription_plan == 'pro_plus' %} Plus{% endif %}</h5>
                        {% if current_limits.monthly_api_limit == 0 and current_limits.monthly_token_limit == 0 %}
                            <span class="badge bg-success">Unlimited Access</span>
                        {% endif %}
                    </div>
                    
                    <!-- Plan Features -->
                    <div class="mb-4">
                        {% if current_limits.monthly_api_limit > 0 %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-check text-success me-3"></i>
                                <span>{{ current_limits.monthly_api_limit|floatformat:0 }} API requests/month</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-infinity text-success me-3"></i>
                                <span>Unlimited API requests</span>
                            </div>
                        {% endif %}
                        
                        {% if current_limits.monthly_token_limit > 0 %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-check text-success me-3"></i>
                                <span>{{ current_limits.monthly_token_limit|floatformat:0 }} tokens/month</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-infinity text-success me-3"></i>
                                <span>Unlimited tokens</span>
                            </div>
                        {% endif %}
                        
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-check text-success me-3"></i>
                            <span>{{ current_limits.max_assistants }} AI Assistant{{ current_limits.max_assistants|pluralize }}</span>
                        </div>
                        
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-check text-success me-3"></i>
                            <span>{{ current_limits.max_knowledge_bases }} Knowledge Base{{ current_limits.max_knowledge_bases|pluralize }}</span>
                        </div>
                        
                        {% if current_limits.features %}
                            {% for feature in current_limits.features %}
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-check text-success me-3"></i>
                                    <span>{{ feature }}</span>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Upgrade Button -->
                    {% if profile.subscription_plan == 'free' %}
                    <a href="#" class="btn btn-primary-modern w-100 mb-3">
                        <i class="fas fa-arrow-up me-2"></i>Upgrade to Pro
                    </a>
                    {% elif profile.subscription_plan == 'pro' %}
                    <a href="#" class="btn btn-primary-modern w-100 mb-3">
                        <i class="fas fa-arrow-up me-2"></i>Upgrade to Pro Plus
                    </a>
                    {% endif %}
                    
                    <div class="text-center">
                        <small class="text-muted">Usage resets on the 1st of each month</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - AI Assistant Overview & Usage Analytics -->
        <div class="col-lg-8">
            
            <!-- AI Assistant Overview -->
            <div class="card-modern mb-4">
                <div class="card-header-modern d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <span>AI Assistant Overview</span>
                    </div>
                    <div class="d-flex gap-2">
                        {% if assistant.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                        {% if assistant.openai_assistant_id %}
                            <span class="badge bg-success">Connected</span>
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body-modern">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light rounded p-2 me-3">
                                    <i class="fas fa-store text-primary-modern"></i>
                                </div>
                                <div>
                                    <p class="mb-0 fw-medium">Business Type</p>
                                    <p class="mb-0 text-muted">{{ assistant.business_type.name }}</p>
                                </div>
                                <a href="{% url 'edit_business_type' %}" class="btn btn-outline-modern btn-sm ms-auto">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light rounded p-2 me-3">
                                    <i class="fas fa-calendar text-primary-modern"></i>
                                </div>
                                <div>
                                    <p class="mb-0 fw-medium">Created</p>
                                    <p class="mb-0 text-muted">{{ assistant.created_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Key Section -->
                    <div class="bg-light rounded-3 p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <p class="mb-1 fw-medium">API Key</p>
                                <code class="small">{{ assistant.api_key }}</code>
                            </div>
                            <button class="btn btn-outline-modern btn-sm" onclick="copyToClipboard('{{ assistant.api_key }}', this)">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Usage Analytics -->
            <div class="card-modern">
                <div class="card-header-modern">
                    <i class="fas fa-chart-line me-2"></i>
                    <span>Usage Analytics</span>
                </div>
                <div class="card-body-modern">
                    
                    <!-- Subscription Plan Badge -->
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h6 class="mb-1">Current Plan</h6>
                            <span class="badge bg-{% if profile.subscription_plan == 'free' %}secondary{% elif profile.subscription_plan == 'pro' %}primary{% else %}success{% endif %} fs-6 text-capitalize">
                                {{ profile.subscription_plan }}{% if profile.subscription_plan == 'pro_plus' %} (Unlimited){% endif %}
                            </span>
                        </div>
                        <small class="text-muted">Resets: {{ profile.last_reset_date|date:"M d, Y" }}</small>
                    </div>
                    
                    <!-- API Requests Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exchange-alt text-primary-modern me-2"></i>
                                <span class="fw-medium">API Requests</span>
                            </div>
                            <span class="badge bg-light text-dark api-limit-text">
                                {{ profile.current_month_api_requests }}{% if current_limits.monthly_api_limit > 0 %}/{{ current_limits.monthly_api_limit }}{% else %} (Unlimited){% endif %}
                            </span>
                        </div>
                        
                        {% if current_limits.monthly_api_limit > 0 %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar api-usage-progress {% if api_usage_percentage > 90 %}bg-danger{% elif api_usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ api_usage_percentage|floatformat:1 }}%; border-radius: 10px;"
                                 aria-valuenow="{{ api_usage_percentage|floatformat:1 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted api-usage-text">{{ api_usage_percentage|floatformat:1 }}% used this month</small>
                        {% else %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar api-usage-progress bg-success" role="progressbar" style="width: 100%; border-radius: 10px;"></div>
                        </div>
                        <small class="text-success api-usage-text"><i class="fas fa-infinity me-1"></i>Unlimited usage</small>
                        {% endif %}
                    </div>
                    
                    <!-- Token Usage Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-coins text-primary-modern me-2"></i>
                                <span class="fw-medium">Token Usage</span>
                            </div>
                            <span class="badge bg-light text-dark token-limit-text">
                                {{ profile.current_month_tokens|floatformat:0 }}{% if current_limits.monthly_token_limit > 0 %}/{{ current_limits.monthly_token_limit|floatformat:0 }}{% else %} (Unlimited){% endif %}
                            </span>
                        </div>
                        
                        {% if current_limits.monthly_token_limit > 0 %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar token-usage-progress {% if token_usage_percentage > 90 %}bg-danger{% elif token_usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ token_usage_percentage|floatformat:1 }}%; border-radius: 10px;"
                                 aria-valuenow="{{ token_usage_percentage|floatformat:1 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted token-usage-text">{{ token_usage_percentage|floatformat:1 }}% used this month</small>
                        {% else %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar token-usage-progress bg-success" role="progressbar" style="width: 100%; border-radius: 10px;"></div>
                        </div>
                        <small class="text-success token-usage-text"><i class="fas fa-infinity me-1"></i>Unlimited usage</small>
                        {% endif %}
                    </div>
                    
                    <!-- Usage Alert -->
                    {% if api_usage_percentage > 90 or token_usage_percentage > 90 %}
                    <div class="alert alert-warning d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Usage Alert:</strong> You're approaching your monthly limit. Consider upgrading your plan.
                        </div>
                    </div>
                    {% elif api_usage_percentage > 75 or token_usage_percentage > 75 %}
                    <div class="alert alert-info d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Usage Notice:</strong> You've used over 75% of your monthly limit.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Widget Integration Section (Full Width) -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-header-modern">
                    <i class="fas fa-code me-2"></i>
                    <span>Widget Integration</span>
                </div>
                <div class="card-body-modern">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h6 class="mb-3">Embed AI Chat Widget</h6>
                            <p class="text-muted mb-3">Copy and paste this code into your website to add the AI chat widget:</p>
                            
                            <div class="bg-light rounded-3 p-3 position-relative">
                                <code class="small d-block text-wrap" style="white-space: pre-wrap;" id="widgetCode">&lt;script src="{{ request.scheme }}://{{ request.get_host }}/widget.js?key={{ assistant.api_key }}&amp;id={{ assistant.id }}"&gt;&lt;/script&gt;</code>
                                <button class="btn btn-outline-modern btn-sm position-absolute top-0 end-0 m-2" onclick="copyToClipboard(document.getElementById('widgetCode').textContent, this)">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4 text-center">
                            <div class="bg-light rounded-3 p-4">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjAiIGZpbGw9InVybCgjZ3JhZGllbnQwXzEyM180NTYpIi8+CjxwYXRoIGQ9Ik03MCAzNUg0MEMzNi42ODYzIDM1IDM0IDM3LjY4NjMgMzQgNDFWNTlDMzQgNjIuMzEzNyAzNi42ODYzIDY1IDQwIDY1SDcwQzczLjMxMzcgNjUgNzYgNjIuMzEzNyA3NiA1OVY0MUM3NiAzNy42ODYzIDczLjMxMzcgMzUgNzAgMzVaIiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSI0NiIgY3k9IjQ4IiByPSIzIiBmaWxsPSIjMDBBREI1Ii8+CjxjaXJjbGUgY3g9IjU1IiBjeT0iNDgiIHI9IjMiIGZpbGw9IiMwMEFEQjUiLz4KPGNpcmNsZSBjeD0iNjQiIGN5PSI0OCIgcj0iMyIgZmlsbD0iIzAwQURCNSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfMTIzXzQ1NiIgeDE9IjAiIHkxPSIwIiB4Mj0iMTAwIiB5Mj0iMTAwIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiMwMEFEQjUiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjMzkzRTQ2Ii8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHN2Zz4K" alt="Widget Preview" class="img-fluid mb-3" style="max-width: 100px;">
                                <p class="text-muted small mb-0">AI Chat Widget</p>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Appears instantly on your website
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
// Modern Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-refresh usage stats every 30 seconds
    setInterval(refreshUsageStats, 30000);
    
    // Add loading states to buttons
    document.querySelectorAll('a[href*="test_"], .test-assistant-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (!this.disabled) {
                setButtonLoading(this);
            }
        });
    });
});

// Enhanced copy functions with modern UI feedback
function copyApiKey() {
    const apiKey = '{{ assistant.api_key }}';
    copyToClipboard(apiKey);
    showToast('API Key copied to clipboard!', 'success');
}

function copyWidgetCode() {
    const widgetCode = document.getElementById('widgetCode').textContent;
    copyToClipboard(widgetCode);
    showToast('Widget code copied to clipboard!', 'success');
}

// Modern toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Enhanced usage stats refresh
function refreshUsageStats() {
    fetch('/api/usage-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateUsageDisplay(data);
            }
        })
        .catch(error => {
            console.error('Error refreshing usage stats:', error);
        });
}

// Modern usage display update
function updateUsageDisplay(data) {
    // Update API requests usage
    updateProgressBar('.api-usage-progress', data.api_usage_percentage);
    updateUsageText('.api-usage-text', data.api_usage_percentage, data.monthly_api_limit > 0);
    updateLimitText('.api-limit-text', data.current_month_api_requests, data.monthly_api_limit);
    
    // Update token usage
    updateProgressBar('.token-usage-progress', data.token_usage_percentage);
    updateUsageText('.token-usage-text', data.token_usage_percentage, data.monthly_token_limit > 0);
    updateLimitText('.token-limit-text', Math.round(data.current_month_tokens), data.monthly_token_limit);
    
    // Update quick stats
    const statsElements = {
        '.total-requests': data.total_api_requests,
        '.total-tokens': Math.round(data.total_tokens)
    };
    
    Object.entries(statsElements).forEach(([selector, value]) => {
        const element = document.querySelector(selector);
        if (element) {
            animateNumber(element, parseInt(element.textContent), value);
        }
    });
    
    // Update usage alert
    updateUsageAlert(data);
    
    // Update button states
    updateButtonStates(data.can_make_api_request);
}

function updateProgressBar(selector, percentage) {
    const progressBar = document.querySelector(selector);
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.className = 'progress-bar';
        
        if (percentage > 90) {
            progressBar.classList.add('bg-danger');
        } else if (percentage > 75) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-success');
        }
    }
}

function updateUsageText(selector, percentage, hasLimit) {
    const element = document.querySelector(selector);
    if (element) {
        if (hasLimit) {
            element.innerHTML = `${percentage.toFixed(1)}% used this month`;
        } else {
            element.innerHTML = '<i class="fas fa-infinity me-1"></i>Unlimited usage';
        }
    }
}

function updateLimitText(selector, current, limit) {
    const element = document.querySelector(selector);
    if (element) {
        if (limit > 0) {
            element.textContent = `${current}/${limit}`;
        } else {
            element.textContent = `${current} (Unlimited)`;
        }
    }
}

function updateUsageAlert(data) {
    const usageAlert = document.getElementById('usage-alert');
    const highUsage = data.api_usage_percentage > 90 || data.token_usage_percentage > 90;
    const moderateUsage = data.api_usage_percentage > 75 || data.token_usage_percentage > 75;
    
    if (highUsage && !usageAlert) {
        createUsageAlert('warning', 'Usage Alert: You\'re approaching your monthly limit. Consider upgrading your plan.');
    } else if (moderateUsage && !usageAlert) {
        createUsageAlert('info', 'Usage Notice: You\'ve used over 75% of your monthly limit.');
    } else if (!highUsage && !moderateUsage && usageAlert) {
        usageAlert.remove();
    }
}

function createUsageAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
            <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <div><strong>${type === 'warning' ? 'Usage Alert' : 'Usage Notice'}:</strong> ${message.split(': ')[1]}</div>
        </div>
    `;
    
    const usageContainer = document.querySelector('.card-modern .card-body-modern');
    if (usageContainer) {
        usageContainer.insertAdjacentHTML('beforeend', alertHtml);
    }
}

function updateButtonStates(canMakeApiRequest) {
    const testButtons = document.querySelectorAll('.test-assistant-btn, .test-chat-btn, .test-voice-btn');
    
    testButtons.forEach(btn => {
        if (!canMakeApiRequest && !btn.disabled) {
            btn.disabled = true;
            btn.className = 'btn btn-outline-secondary w-100';
            btn.title = 'API limit reached';
            
            if (btn.innerHTML.indexOf('lock') === -1) {
                btn.innerHTML += ' <i class="fas fa-lock ms-1"></i>';
            }
        }
    });
}

// Smooth number animation
function animateNumber(element, from, to, duration = 1000) {
    const startTime = performance.now();
    const difference = to - from;
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(from + (difference * easeOutCubic));
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        }
    }
    
    requestAnimationFrame(animate);
}

// Enhanced loading states with modern animations
function setButtonLoading(button, loading = true) {
    if (loading) {
        button.disabled = true;
        const originalText = button.innerHTML;
        button.setAttribute('data-original-text', originalText);
        button.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading...';
        button.classList.add('loading');
    } else {
        button.disabled = false;
        button.innerHTML = button.getAttribute('data-original-text');
        button.classList.remove('loading');
    }
}
</script>

<style>
/* Additional animations for the dashboard */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: slideInUp 0.6s ease-out;
}

.card-modern:nth-child(1) { animation-delay: 0.1s; }
.card-modern:nth-child(2) { animation-delay: 0.2s; }
.card-modern:nth-child(3) { animation-delay: 0.3s; }
.card-modern:nth-child(4) { animation-delay: 0.4s; }

.btn-modern.loading {
    pointer-events: none;
}

.progress-bar {
    transition: width 0.8s ease-in-out, background-color 0.3s ease;
}

/* Toast animations */
.toast {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>
{% endblock %}
{% endblock %}