{% extends 'base.html' %}

{% block title %}Dashboard - AI Agent Customer Service{% endblock %}

{% block content %}
<!-- Hero Section with Gradient Background -->
<div class="bg-gradient-dark text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-gradient-primary rounded-circle p-3 me-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot fs-3"></i>
                    </div>
                    <div>
                        <h1 class="mb-1 fw-bold">Welcome back, {{ user.first_name|default:user.username }}!</h1>
                        <p class="mb-0 opacity-75">Manage your AI assistant and monitor performance</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-inline-flex align-items-center bg-success rounded-pill px-3 py-2">
                    <div class="bg-white rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                    <span class="fw-medium">AI Assistant Active</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-n3 position-relative" style="z-index: 10;">
    
    <!-- Quick Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-comments text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ profile.api_requests_count }}</h3>
                    <p class="text-muted mb-0">Total Conversations</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-brain text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ profile.tokens_used|floatformat:0 }}</h3>
                    <p class="text-muted mb-0">Tokens Processed</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-question-circle text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ assistant.qnas.count }}</h3>
                    <p class="text-muted mb-0">Q&A Pairs</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card-modern h-100">
                <div class="card-body-modern text-center">
                    <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                        <i class="fas fa-database text-white fs-4"></i>
                    </div>
                    <h3 class="fw-bold text-primary-modern mb-1">{{ assistant.knowledge_base.count }}</h3>
                    <p class="text-muted mb-0">Knowledge Items</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Row - AI Assistant & Usage -->
    <div class="row g-4 mb-5">
        
        <!-- Left Column - Subscription Plan (Full Height) -->
        <div class="col-lg-4">
            <div class="card-modern h-100">
                <div class="card-header-modern">
                    <i class="fas fa-crown me-2"></i>
                    <span>Subscription Plan</span>
                </div>
                <div class="card-body-modern">
                    <div class="text-center mb-4">
                        <div class="bg-gradient-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                            <i class="fas fa-{% if profile.subscription_plan == 'free' %}gift{% elif profile.subscription_plan == 'pro' %}star{% else %}crown{% endif %} text-white fs-4"></i>
                        </div>
                        <h5 class="fw-bold text-capitalize">{{ profile.subscription_plan }}{% if profile.subscription_plan == 'pro_plus' %} Plus{% endif %}</h5>
                        {% if current_limits.monthly_api_limit == 0 and current_limits.monthly_token_limit == 0 %}
                            <span class="badge bg-success">Unlimited Access</span>
                        {% endif %}
                    </div>
                    
                    <!-- Plan Features -->
                    <div class="mb-4">
                        {% if current_limits.monthly_api_limit > 0 %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-check text-success me-3"></i>
                                <span>{{ current_limits.monthly_api_limit|floatformat:0 }} API requests/month</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-infinity text-success me-3"></i>
                                <span>Unlimited API requests</span>
                            </div>
                        {% endif %}
                        
                        {% if current_limits.monthly_token_limit > 0 %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-check text-success me-3"></i>
                                <span>{{ current_limits.monthly_token_limit|floatformat:0 }} tokens/month</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-infinity text-success me-3"></i>
                                <span>Unlimited tokens</span>
                            </div>
                        {% endif %}
                        
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-check text-success me-3"></i>
                            <span>{{ current_limits.max_assistants }} AI Assistant{{ current_limits.max_assistants|pluralize }}</span>
                        </div>
                        
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-check text-success me-3"></i>
                            <span>{{ current_limits.max_knowledge_bases }} Knowledge Base{{ current_limits.max_knowledge_bases|pluralize }}</span>
                        </div>
                        
                        {% if current_limits.features %}
                            {% for feature in current_limits.features %}
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-check text-success me-3"></i>
                                    <span>{{ feature }}</span>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Upgrade Button -->
                    {% if profile.subscription_plan == 'free' %}
                    <a href="#" class="btn btn-primary-modern w-100 mb-3">
                        <i class="fas fa-arrow-up me-2"></i>Upgrade to Pro
                    </a>
                    {% elif profile.subscription_plan == 'pro' %}
                    <a href="#" class="btn btn-primary-modern w-100 mb-3">
                        <i class="fas fa-arrow-up me-2"></i>Upgrade to Pro Plus
                    </a>
                    {% endif %}
                    
                    <div class="text-center">
                        <small class="text-muted">Usage resets on the 1st of each month</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - AI Assistant Overview & Usage Analytics -->
        <div class="col-lg-8">
            
            <!-- AI Assistant Overview -->
            <div class="card-modern mb-4">
                <div class="card-header-modern d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <span>AI Assistant Overview</span>
                    </div>
                    <div class="d-flex gap-2">
                        {% if assistant.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                        {% if assistant.openai_assistant_id %}
                            <span class="badge bg-success">Connected</span>
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body-modern">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light rounded p-2 me-3">
                                    <i class="fas fa-store text-primary-modern"></i>
                                </div>
                                <div>
                                    <p class="mb-0 fw-medium">Business Type</p>
                                    <p class="mb-0 text-muted">{{ assistant.business_type.name }}</p>
                                </div>
                                <a href="{% url 'edit_business_type' %}" class="btn btn-outline-modern btn-sm ms-auto">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light rounded p-2 me-3">
                                    <i class="fas fa-calendar text-primary-modern"></i>
                                </div>
                                <div>
                                    <p class="mb-0 fw-medium">Created</p>
                                    <p class="mb-0 text-muted">{{ assistant.created_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Key Section -->
                    <div class="bg-light rounded-3 p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <p class="mb-1 fw-medium">API Key</p>
                                <code class="small">{{ assistant.api_key }}</code>
                            </div>
                            <button class="btn btn-outline-modern btn-sm" onclick="copyToClipboard('{{ assistant.api_key }}', this)">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Usage Analytics -->
            <div class="card-modern">
                <div class="card-header-modern">
                    <i class="fas fa-chart-line me-2"></i>
                    <span>Usage Analytics</span>
                </div>
                <div class="card-body-modern">
                    
                    <!-- Subscription Plan Badge -->
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h6 class="mb-1">Current Plan</h6>
                            <span class="badge bg-{% if profile.subscription_plan == 'free' %}secondary{% elif profile.subscription_plan == 'pro' %}primary{% else %}success{% endif %} fs-6 text-capitalize">
                                {{ profile.subscription_plan }}{% if profile.subscription_plan == 'pro_plus' %} (Unlimited){% endif %}
                            </span>
                        </div>
                        <small class="text-muted">Resets: {{ profile.last_reset_date|date:"M d, Y" }}</small>
                    </div>
                    
                    <!-- API Requests Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exchange-alt text-primary-modern me-2"></i>
                                <span class="fw-medium">API Requests</span>
                            </div>
                            <span class="badge bg-light text-dark api-limit-text">
                                {{ profile.current_month_api_requests }}{% if current_limits.monthly_api_limit > 0 %}/{{ current_limits.monthly_api_limit }}{% else %} (Unlimited){% endif %}
                            </span>
                        </div>
                        
                        {% if current_limits.monthly_api_limit > 0 %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar api-usage-progress {% if api_usage_percentage > 90 %}bg-danger{% elif api_usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ api_usage_percentage|floatformat:1 }}%; border-radius: 10px;"
                                 aria-valuenow="{{ api_usage_percentage|floatformat:1 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted api-usage-text">{{ api_usage_percentage|floatformat:1 }}% used this month</small>
                        {% else %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar api-usage-progress bg-success" role="progressbar" style="width: 100%; border-radius: 10px;"></div>
                        </div>
                        <small class="text-success api-usage-text"><i class="fas fa-infinity me-1"></i>Unlimited usage</small>
                        {% endif %}
                    </div>
                    
                    <!-- Token Usage Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-coins text-primary-modern me-2"></i>
                                <span class="fw-medium">Token Usage</span>
                            </div>
                            <span class="badge bg-light text-dark token-limit-text">
                                {{ profile.current_month_tokens|floatformat:0 }}{% if current_limits.monthly_token_limit > 0 %}/{{ current_limits.monthly_token_limit|floatformat:0 }}{% else %} (Unlimited){% endif %}
                            </span>
                        </div>
                        
                        {% if current_limits.monthly_token_limit > 0 %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar token-usage-progress {% if token_usage_percentage > 90 %}bg-danger{% elif token_usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ token_usage_percentage|floatformat:1 }}%; border-radius: 10px;"
                                 aria-valuenow="{{ token_usage_percentage|floatformat:1 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted token-usage-text">{{ token_usage_percentage|floatformat:1 }}% used this month</small>
                        {% else %}
                        <div class="progress mb-2" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar token-usage-progress bg-success" role="progressbar" style="width: 100%; border-radius: 10px;"></div>
                        </div>
                        <small class="text-success token-usage-text"><i class="fas fa-infinity me-1"></i>Unlimited usage</small>
                        {% endif %}
                    </div>
                    
                    <!-- Usage Alert -->
                    {% if api_usage_percentage > 90 or token_usage_percentage > 90 %}
                    <div class="alert alert-warning d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Usage Alert:</strong> You're approaching your monthly limit. Consider upgrading your plan.
                        </div>
                    </div>
                    {% elif api_usage_percentage > 75 or token_usage_percentage > 75 %}
                    <div class="alert alert-info d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Usage Notice:</strong> You've used over 75% of your monthly limit.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Widget Integration Section (Full Width) -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern widget-integration-section">
                <div class="card-header-modern d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-code me-2 text-primary"></i>
                        <span class="fw-bold">Widget Integration</span>
                    </div>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Live & Ready
                    </span>
                </div>
                <div class="card-body-modern">
                    <div class="row align-items-center g-4">
                        <div class="col-lg-8">
                            <div class="mb-4">
                                <h5 class="mb-2 d-flex align-items-center">
                                    <i class="fas fa-puzzle-piece me-2 text-primary"></i>
                                    Embed AI Chat Widget
                                </h5>
                                <p class="text-muted mb-3">Simply copy and paste this code snippet before the closing <code>&lt;/body&gt;</code> tag of your website:</p>
                            </div>
                            
                            <div class="code-container p-4 position-relative">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                                            <i class="fas fa-code text-white" style="font-size: 10px;"></i>
                                        </div>
                                        <span class="fw-medium small text-muted">HTML Code Snippet</span>
                                    </div>
                                    <button class="btn copy-btn-enhanced btn-sm" onclick="copyWidgetCodeSafe(this)" id="copyWidgetBtn">
                                        <i class="fas fa-copy me-1"></i>Copy Code
                                    </button>
                                </div>
                                <div class="bg-dark rounded-2 p-3">
                                    <code class="text-light d-block text-wrap" style="white-space: pre-wrap; font-family: 'Courier New', monospace;" id="widgetCode">&lt;script src="{{ request.scheme }}://{{ request.get_host }}/widget.js?key={{ assistant.api_key }}&amp;id={{ assistant.id }}"&gt;&lt;/script&gt;</code>
                                </div>
                                <div class="mt-3">
                                    <div class="row g-3">
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-shield-alt me-2"></i>
                                                <small>Secure & Privacy-focused</small>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-mobile-alt me-2"></i>
                                                <small>Mobile-responsive design</small>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-rocket me-2"></i>
                                                <small>Lightweight & fast loading</small>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-cogs me-2"></i>
                                                <small>Auto-updates with improvements</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="text-center">
                                <h6 class="mb-3">Widget Preview</h6>
                                <div class="widget-preview-container position-relative bg-gradient-to-br from-teal-400 to-blue-600 rounded-4 p-4 mb-3" style="background: linear-gradient(135deg, #00ADB5 0%, #393E46 100%); min-height: 200px;">
                                    <div class="widget-mockup position-absolute bottom-0 end-0 m-3">
                                        <div class="chat-bubble bg-white rounded-4 shadow-lg p-3" style="max-width: 250px; animation: float 3s ease-in-out infinite;">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="bg-primary rounded-circle p-1 me-2" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-robot text-white" style="font-size: 12px;"></i>
                                                </div>
                                                <span class="fw-medium small">AI Assistant</span>
                                                <div class="ms-auto">
                                                    <div class="bg-success rounded-circle" style="width: 8px; height: 8px;"></div>
                                                </div>
                                            </div>
                                            <p class="small mb-2 text-muted">Hello! How can I help you today?</p>
                                            <div class="typing-indicator">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                        <div class="chat-button bg-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; cursor: pointer; animation: pulse 2s infinite;">
                                            <i class="fas fa-comment text-white fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="browser-mockup position-absolute top-0 start-0 m-3 bg-white rounded-2 p-2" style="width: 200px;">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="browser-dots d-flex gap-1">
                                                <div class="bg-danger rounded-circle" style="width: 8px; height: 8px;"></div>
                                                <div class="bg-warning rounded-circle" style="width: 8px; height: 8px;"></div>
                                                <div class="bg-success rounded-circle" style="width: 8px; height: 8px;"></div>
                                            </div>
                                            <div class="ms-2 bg-light rounded-pill px-2 py-1 flex-grow-1">
                                                <small class="text-muted">yourwebsite.com</small>
                                            </div>
                                        </div>
                                        <div class="bg-light rounded-1" style="height: 80px;">
                                            <div class="p-2">
                                                <div class="bg-secondary rounded-1 mb-1" style="height: 8px; width: 80%;"></div>
                                                <div class="bg-secondary rounded-1 mb-1" style="height: 8px; width: 60%;"></div>
                                                <div class="bg-secondary rounded-1" style="height: 8px; width: 90%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center justify-content-center gap-2">
                                    <div class="text-success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <span class="small fw-medium text-success">Ready to deploy</span>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    Responsive design works on all devices
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
// Modern Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-refresh usage stats every 30 seconds
    setInterval(refreshUsageStats, 30000);
    
    // Add loading states to buttons
    document.querySelectorAll('a[href*="test_"], .test-assistant-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (!this.disabled) {
                setButtonLoading(this);
            }
        });
    });
});

// Safe clipboard copy function to prevent conflicts
function copyToClipboardSafe(text, button = null) {
    if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text).then(() => {
            if (button) {
                updateCopyButtonState(button, true);
            }
            return true;
        }).catch((err) => {
            console.error('Failed to copy using Clipboard API:', err);
            return fallbackCopyTextToClipboard(text, button);
        });
    } else {
        return fallbackCopyTextToClipboard(text, button);
    }
}

function fallbackCopyTextToClipboard(text, button = null) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful && button) {
            updateCopyButtonState(button, true);
        }
        return successful;
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        if (button) {
            updateCopyButtonState(button, false);
        }
        return false;
    } finally {
        document.body.removeChild(textArea);
    }
}

function updateCopyButtonState(button, success) {
    const originalContent = button.innerHTML;
    if (success) {
        button.innerHTML = '<i class="fas fa-check me-1 text-success"></i>Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-modern');
        showToast('Widget code copied to clipboard!', 'success');
    } else {
        button.innerHTML = '<i class="fas fa-times me-1 text-danger"></i>Failed';
        button.classList.add('btn-danger');
        button.classList.remove('btn-outline-modern');
        showToast('Failed to copy widget code!', 'danger');
    }
    
    setTimeout(() => {
        button.innerHTML = originalContent;
        button.classList.remove('btn-success', 'btn-danger');
        button.classList.add('btn-outline-modern');
    }, 2000);
}

// Enhanced copy functions with modern UI feedback
function copyApiKey() {
    const apiKey = '{{ assistant.api_key }}';
    copyToClipboardSafe(apiKey);
}

function copyWidgetCode() {
    const widgetCode = document.getElementById('widgetCode').textContent;
    copyToClipboardSafe(widgetCode);
}

function copyWidgetCodeSafe(button) {
    const widgetCode = document.getElementById('widgetCode').textContent;
    copyToClipboardSafe(widgetCode, button);
}

// Modern toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Enhanced usage stats refresh
function refreshUsageStats() {
    fetch('/api/usage-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateUsageDisplay(data);
            }
        })
        .catch(error => {
            console.error('Error refreshing usage stats:', error);
        });
}

// Modern usage display update
function updateUsageDisplay(data) {
    // Update API requests usage
    updateProgressBar('.api-usage-progress', data.api_usage_percentage);
    updateUsageText('.api-usage-text', data.api_usage_percentage, data.monthly_api_limit > 0);
    updateLimitText('.api-limit-text', data.current_month_api_requests, data.monthly_api_limit);
    
    // Update token usage
    updateProgressBar('.token-usage-progress', data.token_usage_percentage);
    updateUsageText('.token-usage-text', data.token_usage_percentage, data.monthly_token_limit > 0);
    updateLimitText('.token-limit-text', Math.round(data.current_month_tokens), data.monthly_token_limit);
    
    // Update quick stats
    const statsElements = {
        '.total-requests': data.total_api_requests,
        '.total-tokens': Math.round(data.total_tokens)
    };
    
    Object.entries(statsElements).forEach(([selector, value]) => {
        const element = document.querySelector(selector);
        if (element) {
            animateNumber(element, parseInt(element.textContent), value);
        }
    });
    
    // Update usage alert
    updateUsageAlert(data);
    
    // Update button states
    updateButtonStates(data.can_make_api_request);
}

function updateProgressBar(selector, percentage) {
    const progressBar = document.querySelector(selector);
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.className = 'progress-bar';
        
        if (percentage > 90) {
            progressBar.classList.add('bg-danger');
        } else if (percentage > 75) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-success');
        }
    }
}

function updateUsageText(selector, percentage, hasLimit) {
    const element = document.querySelector(selector);
    if (element) {
        if (hasLimit) {
            element.innerHTML = `${percentage.toFixed(1)}% used this month`;
        } else {
            element.innerHTML = '<i class="fas fa-infinity me-1"></i>Unlimited usage';
        }
    }
}

function updateLimitText(selector, current, limit) {
    const element = document.querySelector(selector);
    if (element) {
        if (limit > 0) {
            element.textContent = `${current}/${limit}`;
        } else {
            element.textContent = `${current} (Unlimited)`;
        }
    }
}

function updateUsageAlert(data) {
    const usageAlert = document.getElementById('usage-alert');
    const highUsage = data.api_usage_percentage > 90 || data.token_usage_percentage > 90;
    const moderateUsage = data.api_usage_percentage > 75 || data.token_usage_percentage > 75;
    
    if (highUsage && !usageAlert) {
        createUsageAlert('warning', 'Usage Alert: You\'re approaching your monthly limit. Consider upgrading your plan.');
    } else if (moderateUsage && !usageAlert) {
        createUsageAlert('info', 'Usage Notice: You\'ve used over 75% of your monthly limit.');
    } else if (!highUsage && !moderateUsage && usageAlert) {
        usageAlert.remove();
    }
}

function createUsageAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} d-flex align-items-center" id="usage-alert" style="border-radius: 12px; border: none;">
            <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <div><strong>${type === 'warning' ? 'Usage Alert' : 'Usage Notice'}:</strong> ${message.split(': ')[1]}</div>
        </div>
    `;
    
    const usageContainer = document.querySelector('.card-modern .card-body-modern');
    if (usageContainer) {
        usageContainer.insertAdjacentHTML('beforeend', alertHtml);
    }
}

function updateButtonStates(canMakeApiRequest) {
    const testButtons = document.querySelectorAll('.test-assistant-btn, .test-chat-btn, .test-voice-btn');
    
    testButtons.forEach(btn => {
        if (!canMakeApiRequest && !btn.disabled) {
            btn.disabled = true;
            btn.className = 'btn btn-outline-secondary w-100';
            btn.title = 'API limit reached';
            
            if (btn.innerHTML.indexOf('lock') === -1) {
                btn.innerHTML += ' <i class="fas fa-lock ms-1"></i>';
            }
        }
    });
}

// Smooth number animation
function animateNumber(element, from, to, duration = 1000) {
    const startTime = performance.now();
    const difference = to - from;
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(from + (difference * easeOutCubic));
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        }
    }
    
    requestAnimationFrame(animate);
}

// Enhanced loading states with modern animations
function setButtonLoading(button, loading = true) {
    if (loading) {
        button.disabled = true;
        const originalText = button.innerHTML;
        button.setAttribute('data-original-text', originalText);
        button.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading...';
        button.classList.add('loading');
    } else {
        button.disabled = false;
        button.innerHTML = button.getAttribute('data-original-text');
        button.classList.remove('loading');
    }
}
</script>

<style>
/* Additional animations for the dashboard */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-modern {
    animation: slideInUp 0.6s ease-out;
}

.card-modern:nth-child(1) { animation-delay: 0.1s; }
.card-modern:nth-child(2) { animation-delay: 0.2s; }
.card-modern:nth-child(3) { animation-delay: 0.3s; }
.card-modern:nth-child(4) { animation-delay: 0.4s; }

.btn-modern.loading {
    pointer-events: none;
}

.progress-bar {
    transition: width 0.8s ease-in-out, background-color 0.3s ease;
}

/* Toast animations */
.toast {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Widget Preview Animations */
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.chat-bubble {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.chat-button {
    box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
}

.chat-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0, 123, 255, 0.4);
}

.widget-preview-container {
    border: 2px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    position: relative;
}

.widget-preview-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
    pointer-events: none;
}

.browser-mockup {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
}

/* Typing indicator animation */
.typing-indicator {
    display: flex;
    gap: 3px;
    align-items: center;
    padding: 4px 0;
}

.typing-indicator span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}

/* Enhanced widget integration section */
.widget-integration-section {
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
    border-radius: 16px;
    position: relative;
    overflow: hidden;
}

.widget-integration-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #00ADB5 0%, #393E46 100%);
}

.code-container {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    position: relative;
    transition: all 0.3s ease;
}

.code-container:hover {
    border-color: #00ADB5;
    box-shadow: 0 4px 20px rgba(0, 173, 181, 0.1);
}

.copy-btn-enhanced {
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 173, 181, 0.2);
}

.copy-btn-enhanced:hover {
    background: rgba(0, 173, 181, 0.1);
    border-color: #00ADB5;
    transform: translateY(-1px);
}
</style>
{% endblock %}
{% endblock %}