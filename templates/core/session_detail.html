{% extends 'base.html' %}

{% block title %}Session Detail - AI Agent{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>üí¨ Session Detail</h2>
                    <div class="d-flex gap-2 mt-2">
                        {% if session.source == 'test_chat' %}
                            <span class="badge bg-info">üí¨ Test Chat</span>
                        {% elif session.source == 'test_voice_realtime' %}
                            <span class="badge bg-primary">üé§ Test Voice Realtime</span>
                        {% elif session.source == 'widget_chat' %}
                            <span class="badge bg-success">üîó Widget Chat</span>
                        {% elif session.source == 'widget_voice' %}
                            <span class="badge bg-warning">üîä Widget Voice</span>
                        {% endif %}
                        <small class="text-muted">{{ session.messages|length }} messages</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'session_history' %}" class="btn btn-outline-secondary">
                        ‚¨ÖÔ∏è Back to History
                    </a>
                    <button type="button" 
                            class="btn btn-outline-danger"
                            onclick="deleteSession('{{ session.session_id }}')">
                        üóëÔ∏è Delete Session
                    </button>
                </div>
            </div>

            <!-- Session Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Session ID:</strong><br>
                            <code class="text-muted">{{ session.session_id }}</code>
                        </div>
                        <div class="col-md-3">
                            <strong>Created:</strong><br>
                            <span class="text-muted">{{ session.created_at|date:"M d, Y H:i:s" }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Updated:</strong><br>
                            <span class="text-muted">{{ session.updated_at|date:"M d, Y H:i:s" }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Duration:</strong><br>
                            <span class="text-muted">{{ session.updated_at|timesince:session.created_at }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üí¨ Conversation</h5>
                </div>
                <div class="card-body">
                    {% if session.messages %}
                        <div class="chat-container" style="max-height: 70vh; overflow-y: auto;">
                            {% for message in session.messages %}
                                <div class="message-wrapper mb-3">
                                    <div class="d-flex {% if message.type == 'user' %}justify-content-end{% endif %}">
                                        <div class="message-bubble 
                                                    {% if message.type == 'user' %}
                                                        bg-primary text-white ms-5
                                                    {% else %}
                                                        bg-light me-5
                                                    {% endif %} 
                                                    p-3 rounded" 
                                             style="max-width: 80%;">
                                            
                                            <!-- Message Header -->
                                            <div class="message-header mb-2 d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center gap-2">
                                                    {% if message.type == 'user' %}
                                                        <span class="badge bg-light text-dark">üë§ You</span>
                                                    {% else %}
                                                        <span class="badge bg-dark">ü§ñ Assistant</span>
                                                    {% endif %}
                                                    
                                                    {% if message.is_voice %}
                                                        <span class="badge bg-warning text-dark">üé§ Voice</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">üí¨ Text</span>
                                                    {% endif %}
                                                </div>
                                                
                                                <small class="text-muted">
                                                    {{ message.timestamp|date:"H:i:s" }}
                                                </small>
                                            </div>
                                            
                                            <!-- Message Content -->
                                            <div class="message-content">
                                                <div style="white-space: pre-wrap; word-wrap: break-word;">{{ message.content }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Export Options -->
                        <div class="mt-4 border-top pt-3">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportSession('txt')">
                                    üìÑ Export as TXT
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="exportSession('json')">
                                    üìã Export as JSON
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="copyToClipboard()">
                                    üìã Copy to Clipboard
                                </button>
                            </div>
                        </div>
                        
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-comments fa-3x text-muted"></i>
                            </div>
                            <h5 class="text-muted">No Messages</h5>
                            <p class="text-muted">This session doesn't have any messages yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
        fetch(`/delete-session/${sessionId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/session-history/';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting session: ' + error);
        });
    }
}

function exportSession(format) {
    const messages = {{ session.messages|safe|escapejs }};
    const sessionInfo = {
        session_id: '{{ session.session_id }}',
        source: '{{ session.source }}',
        created_at: '{{ session.created_at|date:"c" }}',
        updated_at: '{{ session.updated_at|date:"c" }}'
    };
    
    let content = '';
    let filename = `session_${sessionInfo.session_id.substring(0, 8)}_${sessionInfo.source}`;
    
    if (format === 'txt') {
        content = `Session Export\n`;
        content += `=================\n`;
        content += `Session ID: ${sessionInfo.session_id}\n`;
        content += `Source: ${sessionInfo.source}\n`;
        content += `Created: ${sessionInfo.created_at}\n`;
        content += `Updated: ${sessionInfo.updated_at}\n`;
        content += `Messages: ${messages.length}\n\n`;
        
        messages.forEach(msg => {
            const timestamp = new Date(msg.timestamp).toLocaleString();
            const type = msg.type === 'user' ? 'You' : 'Assistant';
            const voice = msg.is_voice ? ' (Voice)' : '';
            content += `[${timestamp}] ${type}${voice}:\n${msg.content}\n\n`;
        });
        
        filename += '.txt';
    } else if (format === 'json') {
        content = JSON.stringify({
            session: sessionInfo,
            messages: messages
        }, null, 2);
        filename += '.json';
    }
    
    downloadFile(content, filename);
}

function copyToClipboard() {
    const messages = {{ session.messages|safe|escapejs }};
    let content = '';
    
    messages.forEach(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleString();
        const type = msg.type === 'user' ? 'You' : 'Assistant';
        const voice = msg.is_voice ? ' (Voice)' : '';
        content += `[${timestamp}] ${type}${voice}:\n${msg.content}\n\n`;
    });
    
    navigator.clipboard.writeText(content).then(() => {
        alert('Conversation copied to clipboard!');
    }).catch(err => {
        alert('Failed to copy to clipboard: ' + err);
    });
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Auto scroll to bottom on load
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>

{{ session.messages|json_script:"session-messages" }}
{{ session|json_script:"session-data" }}

<script>
// Get data from Django template safely
const sessionMessages = JSON.parse(document.getElementById('session-messages').textContent);
const sessionData = JSON.parse(document.getElementById('session-data').textContent);

function exportSession(format) {
    const messages = sessionMessages;
    const sessionInfo = {
        session_id: sessionData.session_id,
        source: sessionData.source,
        created_at: sessionData.created_at,
        updated_at: sessionData.updated_at
    };
    
    let content = '';
    let filename = `session_${sessionInfo.session_id.substring(0, 8)}_${sessionInfo.source}`;
    
    if (format === 'txt') {
        content = `AI Agent Session Export\n`;
        content += `==========================\n`;
        content += `Session ID: ${sessionInfo.session_id}\n`;
        content += `Source: ${getSourceLabel(sessionInfo.source)}\n`;
        content += `Created: ${new Date(sessionInfo.created_at).toLocaleString()}\n`;
        content += `Updated: ${new Date(sessionInfo.updated_at).toLocaleString()}\n`;
        content += `Total Messages: ${messages.length}\n`;
        content += `==========================\n\n`;
        
        messages.forEach((msg, index) => {
            const timestamp = new Date(msg.timestamp).toLocaleString();
            const type = msg.type === 'user' ? 'You' : 'AI Assistant';
            const voice = msg.is_voice ? ' üé§' : ' üí¨';
            content += `[${index + 1}] ${timestamp}\n`;
            content += `${type}${voice}:\n`;
            content += `${msg.content}\n`;
            content += `${'='.repeat(50)}\n\n`;
        });
        
        filename += '.txt';
        downloadFile(content, filename, 'text/plain');
        
    } else if (format === 'json') {
        const exportData = {
            export_info: {
                export_date: new Date().toISOString(),
                format: 'JSON',
                source: 'AI Agent Session Export'
            },
            session: sessionInfo,
            statistics: {
                total_messages: messages.length,
                user_messages: messages.filter(m => m.type === 'user').length,
                assistant_messages: messages.filter(m => m.type === 'assistant').length,
                voice_messages: messages.filter(m => m.is_voice).length,
                text_messages: messages.filter(m => !m.is_voice).length
            },
            messages: messages.map((msg, index) => ({
                index: index + 1,
                id: msg.id,
                type: msg.type,
                content: msg.content,
                is_voice: msg.is_voice,
                timestamp: msg.timestamp,
                formatted_timestamp: new Date(msg.timestamp).toLocaleString()
            }))
        };
        
        content = JSON.stringify(exportData, null, 2);
        filename += '.json';
        downloadFile(content, filename, 'application/json');
    }
}

function copyToClipboard() {
    const messages = sessionMessages;
    let content = `AI Agent Session Export\n`;
    content += `==========================\n`;
    content += `Session: ${sessionData.session_id}\n`;
    content += `Source: ${getSourceLabel(sessionData.source)}\n`;
    content += `Date: ${new Date(sessionData.created_at).toLocaleString()}\n`;
    content += `Messages: ${messages.length}\n`;
    content += `==========================\n\n`;
    
    messages.forEach((msg, index) => {
        const timestamp = new Date(msg.timestamp).toLocaleString();
        const type = msg.type === 'user' ? 'You' : 'AI Assistant';
        const voice = msg.is_voice ? ' üé§' : ' üí¨';
        content += `[${index + 1}] ${timestamp}\n`;
        content += `${type}${voice}: ${msg.content}\n\n`;
    });
    
    navigator.clipboard.writeText(content).then(() => {
        showNotification('‚úÖ Conversation copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Clipboard error:', err);
        // Fallback for older browsers
        fallbackCopyToClipboard(content);
    });
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showNotification('‚úÖ Conversation copied to clipboard!', 'success');
        } else {
            showNotification('‚ùå Failed to copy to clipboard', 'error');
        }
    } catch (err) {
        showNotification('‚ùå Copy not supported by browser', 'error');
    } finally {
        document.body.removeChild(textArea);
    }
}

function downloadFile(content, filename, mimeType = 'text/plain') {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification(`üì• ${filename} downloaded successfully!`, 'success');
}

function getSourceLabel(source) {
    const labels = {
        'test_chat': 'Test Chat',
        'test_voice_realtime': 'Test Voice Realtime',
        'widget_chat': 'Widget Chat',
        'widget_voice': 'Widget Voice'
    };
    return labels[source] || source;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
    `;
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="me-2">${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Add CSS for notification animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>

{% csrf_token %}
{% endblock %}